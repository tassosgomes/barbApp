---
status: completed
parallelizable: true
blocked_by: []
---

<task_context>
<domain>backend/api/barbearias</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>low</complexity>
<dependencies>database</dependencies>
<unblocks>8.0</unblocks>
</task_context>

# Tarefa 2.0: Implementar endpoint de dados completos da barbearia

## Visão Geral

Criar endpoint protegido `GET /api/barbearias/me` que retorna todos os dados da barbearia do usuário autenticado (Admin Barbearia). Este endpoint utiliza o `ICurrentUserService` para obter o `BarbeariaId` do JWT e retornar os dados completos.

<requirements>
- Endpoint protegido (requer autenticação)
- Obter `BarbeariaId` do token JWT via `ICurrentUserService`
- Retornar dados completos da barbearia (incluindo contato, endereço)
- Validar que usuário está autenticado como Admin Barbearia
- Retornar 401 se token inválido/expirado
- Retornar 403 se usuário não é Admin Barbearia ou não tem barbearia associada
</requirements>

## Subtarefas

- [x] 2.1 Implementar `GetMyBarbershopUseCase` em `BarbApp.Application/UseCases/`
- [x] 2.2 Criar endpoint `GET /api/barbearias/me` em `BarbershopsController`
- [x] 2.3 Configurar endpoint com [Authorize] e validação de tipo de usuário
- [x] 2.4 Implementar lógica para obter `BarbeariaId` do `ICurrentUserService`
- [x] 2.5 Implementar tratamento de erros (UnauthorizedException, ForbiddenException)
- [x] 2.6 Criar testes unitários para `GetMyBarbershopUseCase`
- [x] 2.7 Criar testes unitários para endpoint no `BarbershopsControllerTests` (substituído por testes de integração abrangentes)
- [x] 2.8 Criar testes de integração com autenticação JWT
- [x] 2.9 Atualizar documentação Swagger

## Sequenciamento

- **Bloqueado por:** Nenhuma tarefa
- **Desbloqueia:** 8.0 (Dashboard)
- **Paralelizável:** Sim (pode executar em paralelo com 1.0)

## Detalhes de Implementação

### Use Case (GetMyBarbershopUseCase.cs)

```csharp
// BarbApp.Application/UseCases/GetMyBarbershopUseCase.cs
namespace BarbApp.Application.UseCases;

public class GetMyBarbershopUseCase
{
    private readonly IBarbershopRepository _barbershopRepository;
    private readonly ICurrentUserService _currentUserService;

    public GetMyBarbershopUseCase(
        IBarbershopRepository barbershopRepository,
        ICurrentUserService currentUserService)
    {
        _barbershopRepository = barbershopRepository;
        _currentUserService = currentUserService;
    }

    public async Task<Barbershop> ExecuteAsync()
    {
        var barbeariaId = _currentUserService.BarbeariaId;
        
        if (barbeariaId == null)
            throw new ForbiddenException("Usuário não associado a uma barbearia");

        var barbearia = await _barbershopRepository.GetByIdAsync(barbeariaId.Value);
        
        if (barbearia == null)
            throw new NotFoundException("Barbearia não encontrada");

        return barbearia;
    }
}
```

### Controller Endpoint

```csharp
// BarbApp.API/Controllers/BarbershopsController.cs
[ApiController]
[Route("api/barbearias")]
public class BarbershopsController : ControllerBase
{
    [HttpGet("me")]
    [Authorize] // Requer autenticação
    [ProducesResponseType(typeof(Barbershop), 200)]
    [ProducesResponseType(401)]
    [ProducesResponseType(403)]
    [ProducesResponseType(404)]
    public async Task<IActionResult> GetMe(
        [FromServices] GetMyBarbershopUseCase useCase)
    {
        var result = await useCase.ExecuteAsync();
        return Ok(result);
    }
}
```

### Exemplo de Response

**Success (200):**
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "nome": "Barbearia do Tasso Zé",
  "codigo": "6SJJRFPD",
  "email": "contato@barbeariatasso.com",
  "telefone": "(11) 98765-4321",
  "endereco": {
    "rua": "Rua das Flores",
    "numero": "123",
    "bairro": "Centro",
    "cidade": "São Paulo",
    "estado": "SP",
    "cep": "01234-567"
  },
  "isActive": true,
  "createdAt": "2024-01-15T10:00:00Z"
}
```

**Unauthorized (401):**
```json
{
  "message": "Token inválido ou expirado"
}
```

**Forbidden (403):**
```json
{
  "message": "Usuário não associado a uma barbearia"
}
```

## Critérios de Sucesso

- [x] Endpoint `GET /api/barbearias/me` retorna 200 com dados completos da barbearia
- [x] Endpoint requer autenticação (retorna 401 sem token)
- [x] Endpoint valida que usuário é Admin Barbearia (403 para outros tipos)
- [x] Endpoint retorna dados baseados no `BarbeariaId` do token
- [x] Testes unitários com cobertura >= 90%
- [x] Testes de integração com JWT válido e inválido
- [x] Documentação Swagger atualizada
- [x] Isolamento de dados funciona (usuário A não vê dados de barbearia B)

## Arquivos Afetados

- `BarbApp.Application/UseCases/GetMyBarbershopUseCase.cs` (NOVO)
- `BarbApp.API/Controllers/BarbershopsController.cs` (MODIFICADO)
- `BarbApp.Application.Tests/UseCases/GetMyBarbershopUseCaseTests.cs` (NOVO)
- `BarbApp.API.Tests/Controllers/BarbershopsControllerTests.cs` (MODIFICADO)
- `BarbApp.API.IntegrationTests/Controllers/BarbershopsControllerTests.cs` (MODIFICADO)

## Estimativa

- **Esforço:** 1 dia
- **Complexidade:** Baixa
