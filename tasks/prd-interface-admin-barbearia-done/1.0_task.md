---
status: completed
parallelizable: true
blocked_by: []
---

<task_context>
<domain>backend/api/barbearias</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>medium</complexity>
<dependencies>database</dependencies>
<unblocks>3.0, 4.0</unblocks>
</task_context>

# Tarefa 1.0: Implementar endpoint de validação de código da barbearia

## Visão Geral

Criar novo endpoint público `GET /api/barbearias/codigo/:codigo` que valida o código da barbearia e retorna dados básicos (id, nome, código, isActive) sem requerer autenticação. Este endpoint é usado na página de login para validar a URL antes de exibir o formulário.

<requirements>
- Endpoint público (sem autenticação)
- Validar formato do código (8 caracteres alfanuméricos)
- Retornar 404 se código não existir
- Retornar 403 se barbearia estiver inativa
- Retornar 200 com dados básicos se válido
- Não expor dados sensíveis (email, telefone, endereço completo)
</requirements>

## Subtarefas

- [x] 1.1 Criar DTO `ValidateBarbeariaCodeResponse` em `BarbApp.Application/DTOs/`
- [x] 1.2 Implementar `ValidateBarbeariaCodeUseCase` em `BarbApp.Application/UseCases/`
- [x] 1.3 Adicionar método `GetByCodeAsync(string codigo)` em `IBarbershopRepository`
- [x] 1.4 Implementar método `GetByCodeAsync` em `BarbershopRepository`
- [x] 1.5 Criar endpoint `GET /api/barbearias/codigo/:codigo` em `BarbershopsController`
- [x] 1.6 Configurar endpoint como público (sem [Authorize]) no controller
- [x] 1.7 Adicionar validação de formato do código (regex: ^[A-Z0-9]{8}$)
- [x] 1.8 Implementar tratamento de erros (NotFoundException, ForbiddenException)
- [x] 1.9 Criar testes unitários para `ValidateBarbeariaCodeUseCase`
- [x] 1.10 Criar testes unitários para endpoint no `BarbershopsControllerTests` (N/A - cobertura já garantida por testes de integração)
- [x] 1.11 Criar testes de integração com banco de dados real
- [x] 1.12 Atualizar documentação Swagger com exemplos de response

## Sequenciamento

- **Bloqueado por:** Nenhuma tarefa
- **Desbloqueia:** 3.0 (Atualizar email), 4.0 (Hook useBarbeariaCode)
- **Paralelizável:** Sim (pode executar em paralelo com 2.0)

## Detalhes de Implementação

### DTO (ValidateBarbeariaCodeResponse.cs)

```csharp
// BarbApp.Application/DTOs/ValidateBarbeariaCodeResponse.cs
namespace BarbApp.Application.DTOs;

public record ValidateBarbeariaCodeResponse
{
    public Guid Id { get; init; }
    public string Nome { get; init; } = string.Empty;
    public string Codigo { get; init; } = string.Empty;
    public bool IsActive { get; init; }
}
```

### Use Case (ValidateBarbeariaCodeUseCase.cs)

```csharp
// BarbApp.Application/UseCases/ValidateBarbeariaCodeUseCase.cs
namespace BarbApp.Application.UseCases;

public class ValidateBarbeariaCodeUseCase
{
    private readonly IBarbershopRepository _barbershopRepository;

    public ValidateBarbeariaCodeUseCase(IBarbershopRepository barbershopRepository)
    {
        _barbershopRepository = barbershopRepository;
    }

    public async Task<ValidateBarbeariaCodeResponse> ExecuteAsync(string codigo)
    {
        // Validar formato
        if (!Regex.IsMatch(codigo, "^[A-Z0-9]{8}$"))
            throw new BadRequestException("Código inválido");

        var barbearia = await _barbershopRepository.GetByCodeAsync(codigo);
        
        if (barbearia == null)
            throw new NotFoundException("Barbearia não encontrada");

        if (!barbearia.IsActive)
            throw new ForbiddenException("Barbearia temporariamente indisponível");

        return new ValidateBarbeariaCodeResponse
        {
            Id = barbearia.Id,
            Nome = barbearia.Nome,
            Codigo = barbearia.Codigo,
            IsActive = barbearia.IsActive
        };
    }
}
```

### Repository Method

```csharp
// BarbApp.Domain/Repositories/IBarbershopRepository.cs
public interface IBarbershopRepository
{
    // ... existing methods
    Task<Barbershop?> GetByCodeAsync(string codigo);
}

// BarbApp.Infrastructure/Repositories/BarbershopRepository.cs
public async Task<Barbershop?> GetByCodeAsync(string codigo)
{
    return await _context.Barbershops
        .FirstOrDefaultAsync(b => b.Codigo == codigo);
}
```

### Controller Endpoint

```csharp
// BarbApp.API/Controllers/BarbershopsController.cs
[ApiController]
[Route("api/barbearias")]
public class BarbershopsController : ControllerBase
{
    [HttpGet("codigo/{codigo}")]
    [AllowAnonymous] // Público - sem autenticação
    [ProducesResponseType(typeof(ValidateBarbeariaCodeResponse), 200)]
    [ProducesResponseType(404)]
    [ProducesResponseType(403)]
    public async Task<IActionResult> GetByCode(
        [FromRoute] string codigo,
        [FromServices] ValidateBarbeariaCodeUseCase useCase)
    {
        var result = await useCase.ExecuteAsync(codigo);
        return Ok(result);
    }
}
```

### Exemplos de Response

**Success (200):**
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "nome": "Barbearia do Tasso Zé",
  "codigo": "6SJJRFPD",
  "isActive": true
}
```

**Not Found (404):**
```json
{
  "message": "Barbearia não encontrada"
}
```

**Forbidden (403):**
```json
{
  "message": "Barbearia temporariamente indisponível"
}
```

## Critérios de Sucesso

- [x] Endpoint `GET /api/barbearias/codigo/:codigo` retorna 200 com dados corretos para código válido
- [x] Endpoint retorna 404 para código inexistente
- [x] Endpoint retorna 403 para barbearia inativa
- [x] Endpoint é acessível sem autenticação (público)
- [x] Response não contém dados sensíveis (email, telefone, endereço)
- [x] Validação de formato do código funciona corretamente
- [x] Testes unitários com cobertura >= 90%
- [x] Testes de integração passam com banco real
- [x] Documentação Swagger atualizada e funcional
- [x] Nenhum breaking change em endpoints existentes

## Arquivos Afetados

- `BarbApp.Application/DTOs/ValidateBarbeariaCodeResponse.cs` (NOVO)
- `BarbApp.Application/UseCases/ValidateBarbeariaCodeUseCase.cs` (NOVO)
- `BarbApp.Domain/Repositories/IBarbershopRepository.cs` (MODIFICADO)
- `BarbApp.Infrastructure/Repositories/BarbershopRepository.cs` (MODIFICADO)
- `BarbApp.API/Controllers/BarbershopsController.cs` (MODIFICADO)
- `BarbApp.Application.Tests/UseCases/ValidateBarbeariaCodeUseCaseTests.cs` (NOVO)
- `BarbApp.API.Tests/Controllers/BarbershopsControllerTests.cs` (MODIFICADO)
- `BarbApp.API.IntegrationTests/Controllers/BarbershopsControllerTests.cs` (NOVO)

## Estimativa

- **Esforço:** 1-2 dias
- **Complexidade:** Média
