---
status: completed
parallelizable: false
blocked_by: ["4.0", "5.0"]
---

<task_context>
<domain>frontend/pages/auth</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>high</complexity>
<dependencies>http_server</dependencies>
<unblocks>7.0</unblocks>
</task_context>

# Tarefa 6.0: Implementar página de login para Admin Barbearia

## Visão Geral

Criar página completa de login `LoginAdminBarbearia` acessível via `/:codigo/login`. A página usa `useBarbeariaCode` para validar o código, exibe o nome da barbearia no header, e autentica via `POST /api/auth/admin-barbearia/login`. Após sucesso, armazena token e redireciona para `/:codigo/dashboard`.

<requirements>
- Página acessível em `/:codigo/login`
- Validar código ao montar usando `useBarbeariaCode`
- Exibir nome da barbearia no cabeçalho
- Formulário com campos: email, senha
- Validação com Zod e React Hook Form
- Integração com endpoint de autenticação
- Armazenar token em localStorage
- Armazenar contexto em BarbeariaContext
- Redirecionamento para `/:codigo/dashboard`
- Tratamento de erros 401, 403, 500
- Estados de loading e feedback visual
</requirements>

## Subtarefas

- [x] 6.1 Criar diretório `src/pages/LoginAdminBarbearia/`
- [x] 6.2 Criar componente `LoginAdminBarbearia.tsx`
- [x] 6.3 Implementar serviço `adminBarbeariaAuth.service.ts`
- [x] 6.4 Criar schema Zod para formulário de login
- [x] 6.5 Integrar `useBarbeariaCode` para validação de código
- [x] 6.6 Integrar `useBarbearia` para armazenar contexto
- [x] 6.7 Implementar formulário com React Hook Form
- [x] 6.8 Adicionar validações de campos
- [x] 6.9 Implementar lógica de autenticação
- [x] 6.10 Armazenar token em localStorage
- [x] 6.11 Implementar redirecionamento pós-login
- [x] 6.12 Adicionar tratamento de erros com toast/alert
- [x] 6.13 Criar componente de loading state
- [x] 6.14 Estilizar com Tailwind e Shadcn/ui
- [x] 6.15 Criar testes unitários
- [x] 6.16 Criar testes de integração

## Sequenciamento

- **Bloqueado por:** 4.0 (useBarbeariaCode), 5.0 (BarbeariaContext)
- **Desbloqueia:** 7.0 (Rotas protegidas)
- **Paralelizável:** Não (depende de 4.0 e 5.0)

## Detalhes de Implementação

### Schema Zod

```typescript
// src/schemas/adminBarbearia.schema.ts
import { z } from 'zod';

export const loginAdminBarbeariaSchema = z.object({
  email: z
    .string()
    .min(1, 'Email é obrigatório')
    .email('Email inválido'),
  senha: z
    .string()
    .min(6, 'Senha deve ter no mínimo 6 caracteres'),
});

export type LoginAdminBarbeariaFormData = z.infer<typeof loginAdminBarbeariaSchema>;
```

### Serviço de Autenticação

```typescript
// src/services/adminBarbeariaAuth.service.ts
import { api } from './api';

export interface LoginAdminBarbeariaRequest {
  codigo: string;
  email: string;
  senha: string;
}

export interface LoginAdminBarbeariaResponse {
  token: string;
  barbeariaId: string;
  nome: string;
  codigo: string;
  expiresAt: string;
}

const TOKEN_KEY = 'admin_barbearia_token';

export const adminBarbeariaAuthService = {
  login: async (request: LoginAdminBarbeariaRequest): Promise<LoginAdminBarbeariaResponse> => {
    const response = await api.post<LoginAdminBarbeariaResponse>(
      '/api/auth/admin-barbearia/login',
      request
    );
    
    // Armazenar token
    localStorage.setItem(TOKEN_KEY, response.data.token);
    
    return response.data;
  },

  logout: () => {
    localStorage.removeItem(TOKEN_KEY);
  },

  getToken: (): string | null => {
    return localStorage.getItem(TOKEN_KEY);
  },

  isAuthenticated: (): boolean => {
    return !!localStorage.getItem(TOKEN_KEY);
  },
};
```

### Componente da Página

```typescript
// src/pages/LoginAdminBarbearia/LoginAdminBarbearia.tsx
import { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useMutation } from '@tanstack/react-query';
import { useBarbeariaCode } from '@/hooks/useBarbeariaCode';
import { useBarbearia } from '@/contexts/BarbeariaContext';
import { adminBarbeariaAuthService } from '@/services/adminBarbeariaAuth.service';
import { loginAdminBarbeariaSchema, type LoginAdminBarbeariaFormData } from '@/schemas/adminBarbearia.schema';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { toast } from 'sonner';

export function LoginAdminBarbearia() {
  const navigate = useNavigate();
  const { codigo, barbeariaInfo, isLoading: isValidatingCode, error: codeError } = useBarbeariaCode();
  const { setBarbearia } = useBarbearia();

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<LoginAdminBarbeariaFormData>({
    resolver: zodResolver(loginAdminBarbeariaSchema),
  });

  const loginMutation = useMutation({
    mutationFn: (data: LoginAdminBarbeariaFormData) =>
      adminBarbeariaAuthService.login({
        codigo: codigo!,
        email: data.email,
        senha: data.senha,
      }),
    onSuccess: (response) => {
      // Armazenar contexto da barbearia
      setBarbearia({
        barbeariaId: response.barbeariaId,
        nome: response.nome,
        codigo: response.codigo,
        isActive: true,
      });

      toast.success('Login realizado com sucesso!');
      
      // Redirecionar para dashboard
      navigate(`/${codigo}/dashboard`);
    },
    onError: (error: any) => {
      if (error.response?.status === 401) {
        toast.error('Email ou senha incorretos');
      } else if (error.response?.status === 403) {
        toast.error('Acesso negado');
      } else {
        toast.error('Erro ao fazer login. Tente novamente.');
      }
    },
  });

  const onSubmit = (data: LoginAdminBarbeariaFormData) => {
    loginMutation.mutate(data);
  };

  // Validação de código
  if (isValidatingCode) {
    return (
      <div className="flex min-h-screen items-center justify-center">
        <Card className="w-96">
          <CardContent className="pt-6">
            <div className="text-center">Validando código da barbearia...</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (codeError) {
    return (
      <div className="flex min-h-screen items-center justify-center">
        <Card className="w-96">
          <CardContent className="pt-6">
            <div className="text-center text-red-600">
              {codeError.message.includes('404')
                ? 'Barbearia não encontrada'
                : codeError.message.includes('403')
                ? 'Barbearia temporariamente indisponível'
                : 'Erro ao validar código'}
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!barbeariaInfo) {
    return (
      <div className="flex min-h-screen items-center justify-center">
        <Card className="w-96">
          <CardContent className="pt-6">
            <div className="text-center text-red-600">Código inválido</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50">
      <Card className="w-96">
        <CardHeader>
          <CardTitle className="text-center">
            🪒 BarbApp
            <div className="text-lg font-normal text-gray-600 mt-2">
              {barbeariaInfo.nome}
            </div>
          </CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium mb-1">
                Email
              </label>
              <Input
                id="email"
                type="email"
                {...register('email')}
                disabled={loginMutation.isPending}
              />
              {errors.email && (
                <p className="text-sm text-red-600 mt-1">{errors.email.message}</p>
              )}
            </div>

            <div>
              <label htmlFor="senha" className="block text-sm font-medium mb-1">
                Senha
              </label>
              <Input
                id="senha"
                type="password"
                {...register('senha')}
                disabled={loginMutation.isPending}
              />
              {errors.senha && (
                <p className="text-sm text-red-600 mt-1">{errors.senha.message}</p>
              )}
            </div>

            <Button
              type="submit"
              className="w-full"
              disabled={loginMutation.isPending}
            >
              {loginMutation.isPending ? 'Entrando...' : 'Entrar'}
            </Button>
          </form>

          <p className="text-center text-sm text-gray-600 mt-4">
            Esqueceu a senha? Contate o suporte
          </p>
        </CardContent>
      </Card>
    </div>
  );
}
```

### Testes

```typescript
// src/pages/LoginAdminBarbearia/__tests__/LoginAdminBarbearia.test.tsx
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { LoginAdminBarbearia } from '../LoginAdminBarbearia';

jest.mock('@/hooks/useBarbeariaCode');
jest.mock('@/contexts/BarbeariaContext');

describe('LoginAdminBarbearia', () => {
  it('should display loading state while validating codigo', async () => {
    (useBarbeariaCode as jest.Mock).mockReturnValue({
      codigo: '6SJJRFPD',
      barbeariaInfo: null,
      isLoading: true,
      error: null,
    });

    render(<LoginAdminBarbearia />);
    
    expect(screen.getByText(/validando código/i)).toBeInTheDocument();
  });

  it('should display form when codigo is valid', async () => {
    (useBarbeariaCode as jest.Mock).mockReturnValue({
      codigo: '6SJJRFPD',
      barbeariaInfo: {
        id: '123',
        nome: 'Barbearia Test',
        codigo: '6SJJRFPD',
        isActive: true,
      },
      isLoading: false,
      error: null,
    });

    render(<LoginAdminBarbearia />);
    
    expect(screen.getByText('Barbearia Test')).toBeInTheDocument();
    expect(screen.getByLabelText('Email')).toBeInTheDocument();
    expect(screen.getByLabelText('Senha')).toBeInTheDocument();
  });

  it('should submit form and redirect on success', async () => {
    // Test implementation
  });

  it('should display error on invalid credentials', async () => {
    // Test implementation
  });
});
```

## Critérios de Sucesso

- [x] Página acessível em `/:codigo/login`
- [x] Código validado automaticamente ao carregar
- [x] Nome da barbearia exibido no cabeçalho
- [x] Formulário valida email e senha
- [x] Login com credenciais válidas funciona
- [x] Token armazenado em localStorage
- [x] Contexto armazenado em BarbeariaContext
- [x] Redirecionamento para `/:codigo/dashboard` após sucesso
- [x] Erro 401 exibe "Email ou senha incorretos"
- [x] Erro 404 exibe "Barbearia não encontrada"
- [x] Loading states funcionam corretamente
- [x] Testes unitários com cobertura >= 80%
- [x] Interface responsiva (mobile-friendly)

## Arquivos Afetados

- `src/pages/LoginAdminBarbearia/LoginAdminBarbearia.tsx` (NOVO)
- `src/services/adminBarbeariaAuth.service.ts` (NOVO)
- `src/schemas/adminBarbearia.schema.ts` (MODIFICADO - adicionar schema de login)
- `src/pages/LoginAdminBarbearia/__tests__/LoginAdminBarbearia.test.tsx` (NOVO)

## Estimativa

- **Esforço:** 2-3 dias
- **Complexidade:** Alta
