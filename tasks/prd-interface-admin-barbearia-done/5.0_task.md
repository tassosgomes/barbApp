---
status: completed
parallelizable: true
blocked_by: ["1.0"]
---

<task_context>
<domain>frontend/contexts</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>medium</complexity>
<dependencies></dependencies>
<unblocks>6.0, 7.0</unblocks>
</task_context>

# Tarefa 5.0: Implementar BarbeariaContext para gerenciamento de estado

## Visão Geral

Criar Context API Provider `BarbeariaContext` que armazena e compartilha o estado global da barbearia ativa (id, nome, código, isActive) em toda a aplicação. Este contexto persiste dados em localStorage e fornece funções para set/clear.

<requirements>
- Context deve armazenar: barbeariaId, nome, codigo, isActive
- Persistir dados em localStorage
- Fornecer funções: setBarbearia, clearBarbearia
- Sincronizar estado com localStorage
- Inicializar contexto ao montar provider
- Validar dados ao carregar de localStorage
- TypeScript types rigorosos
</requirements>

## Subtarefas

- [x] 5.1 Criar arquivo `src/contexts/BarbeariaContext.tsx`
- [x] 5.2 Definir interfaces `BarbeariaContextData` e `BarbeariaContextValue`
- [x] 5.3 Criar Context com `createContext()`
- [x] 5.4 Implementar `BarbeariaProvider` component
- [x] 5.5 Implementar lógica de localStorage (get, set, remove)
- [x] 5.6 Criar custom hook `useBarbearia()` para consumir contexto
- [x] 5.7 Adicionar validação de dados ao carregar de localStorage
- [x] 5.8 Implementar sincronização entre tabs (storage event)
- [x] 5.9 Criar testes unitários em `src/contexts/__tests__/BarbeariaContext.test.tsx`
- [x] 5.10 Documentar uso do contexto com exemplos

## Sequenciamento

- **Bloqueado por:** 1.0 (Precisa de estrutura de dados de BarbeariaInfo)
- **Desbloqueia:** 6.0 (Login), 7.0 (Rotas)
- **Paralelizável:** Sim (pode executar em paralelo com 4.0)

## Detalhes de Implementação

### Interfaces

```typescript
// src/contexts/BarbeariaContext.tsx
import { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { barbeariaInfoSchema } from '@/schemas/adminBarbearia.schema';

export interface BarbeariaContextData {
  barbeariaId: string;
  nome: string;
  codigo: string;
  isActive: boolean;
}

export interface BarbeariaContextValue {
  barbearia: BarbeariaContextData | null;
  setBarbearia: (data: BarbeariaContextData) => void;
  clearBarbearia: () => void;
  isLoaded: boolean;
}

const BarbeariaContext = createContext<BarbeariaContextValue | undefined>(undefined);

const STORAGE_KEY = 'admin_barbearia_context';
```

### Provider Implementation

```typescript
interface BarbeariaProviderProps {
  children: ReactNode;
}

export function BarbeariaProvider({ children }: BarbeariaProviderProps) {
  const [barbearia, setBarbeariaState] = useState<BarbeariaContextData | null>(null);
  const [isLoaded, setIsLoaded] = useState(false);

  // Carregar de localStorage ao montar
  useEffect(() => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        const parsed = JSON.parse(stored);
        // Validar estrutura com Zod
        const validated = barbeariaInfoSchema.parse(parsed);
        setBarbeariaState({
          barbeariaId: validated.id,
          nome: validated.nome,
          codigo: validated.codigo,
          isActive: validated.isActive,
        });
      }
    } catch (error) {
      console.error('Erro ao carregar contexto da barbearia:', error);
      localStorage.removeItem(STORAGE_KEY);
    } finally {
      setIsLoaded(true);
    }
  }, []);

  // Sincronizar mudanças entre tabs
  useEffect(() => {
    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === STORAGE_KEY) {
        if (e.newValue) {
          try {
            const parsed = JSON.parse(e.newValue);
            const validated = barbeariaInfoSchema.parse(parsed);
            setBarbeariaState({
              barbeariaId: validated.id,
              nome: validated.nome,
              codigo: validated.codigo,
              isActive: validated.isActive,
            });
          } catch (error) {
            console.error('Erro ao sincronizar contexto:', error);
          }
        } else {
          setBarbeariaState(null);
        }
      }
    };

    window.addEventListener('storage', handleStorageChange);
    return () => window.removeEventListener('storage', handleStorageChange);
  }, []);

  const setBarbearia = (data: BarbeariaContextData) => {
    setBarbeariaState(data);
    localStorage.setItem(
      STORAGE_KEY,
      JSON.stringify({
        id: data.barbeariaId,
        nome: data.nome,
        codigo: data.codigo,
        isActive: data.isActive,
      })
    );
  };

  const clearBarbearia = () => {
    setBarbeariaState(null);
    localStorage.removeItem(STORAGE_KEY);
  };

  return (
    <BarbeariaContext.Provider
      value={{
        barbearia,
        setBarbearia,
        clearBarbearia,
        isLoaded,
      }}
    >
      {children}
    </BarbeariaContext.Provider>
  );
}
```

### Custom Hook

```typescript
export function useBarbearia(): BarbeariaContextValue {
  const context = useContext(BarbeariaContext);
  
  if (context === undefined) {
    throw new Error('useBarbearia must be used within BarbeariaProvider');
  }
  
  return context;
}
```

### Exemplo de Uso

```typescript
// Em App.tsx ou main.tsx
import { BarbeariaProvider } from '@/contexts/BarbeariaContext';

function App() {
  return (
    <BarbeariaProvider>
      <Router>
        {/* Rotas */}
      </Router>
    </BarbeariaProvider>
  );
}

// Em um componente
import { useBarbearia } from '@/contexts/BarbeariaContext';

function Header() {
  const { barbearia, clearBarbearia } = useBarbearia();

  if (!barbearia) {
    return null;
  }

  return (
    <header>
      <h1>{barbearia.nome}</h1>
      <span>Código: {barbearia.codigo}</span>
      <button onClick={clearBarbearia}>Sair</button>
    </header>
  );
}
```

### Testes Unitários

```typescript
// src/contexts/__tests__/BarbeariaContext.test.tsx
import { render, screen, act } from '@testing-library/react';
import { BarbeariaProvider, useBarbearia } from '../BarbeariaContext';

describe('BarbeariaContext', () => {
  beforeEach(() => {
    localStorage.clear();
  });

  it('should provide barbearia data to children', () => {
    const TestComponent = () => {
      const { barbearia, setBarbearia } = useBarbearia();
      
      return (
        <div>
          <span>{barbearia?.nome ?? 'No barbearia'}</span>
          <button
            onClick={() =>
              setBarbearia({
                barbeariaId: '123',
                nome: 'Test Barbearia',
                codigo: 'TEST1234',
                isActive: true,
              })
            }
          >
            Set
          </button>
        </div>
      );
    };

    render(
      <BarbeariaProvider>
        <TestComponent />
      </BarbeariaProvider>
    );

    expect(screen.getByText('No barbearia')).toBeInTheDocument();

    act(() => {
      screen.getByText('Set').click();
    });

    expect(screen.getByText('Test Barbearia')).toBeInTheDocument();
  });

  it('should persist to localStorage', () => {
    const TestComponent = () => {
      const { setBarbearia } = useBarbearia();
      
      return (
        <button
          onClick={() =>
            setBarbearia({
              barbeariaId: '123',
              nome: 'Test',
              codigo: 'TEST1234',
              isActive: true,
            })
          }
        >
          Set
        </button>
      );
    };

    render(
      <BarbeariaProvider>
        <TestComponent />
      </BarbeariaProvider>
    );

    act(() => {
      screen.getByText('Set').click();
    });

    const stored = localStorage.getItem('admin_barbearia_context');
    expect(stored).toBeTruthy();
    const parsed = JSON.parse(stored!);
    expect(parsed.nome).toBe('Test');
  });

  it('should clear barbearia on logout', () => {
    // Test implementation
  });

  it('should load from localStorage on mount', () => {
    // Test implementation
  });
});
```

## Critérios de Sucesso

- [x] Context armazena dados da barbearia corretamente
- [x] Dados persistem em localStorage
- [x] Hook `useBarbearia()` funciona em componentes filhos
- [x] `setBarbearia()` atualiza estado e localStorage
- [x] `clearBarbearia()` limpa estado e localStorage
- [x] Sincronização entre tabs funciona
- [x] Validação de dados ao carregar de localStorage
- [x] Erro apropriado se usado fora do Provider
- [x] Testes unitários com cobertura >= 80%
- [x] TypeScript types rigorosos (sem any)
- [x] Documentação clara com exemplos

## Arquivos Afetados

- `src/contexts/BarbeariaContext.tsx` (NOVO)
- `src/contexts/__tests__/BarbeariaContext.test.tsx` (NOVO)
- `src/App.tsx` ou `src/main.tsx` (MODIFICADO - adicionar Provider)

## Estimativa

- **Esforço:** 1-2 dias
- **Complexidade:** Média
