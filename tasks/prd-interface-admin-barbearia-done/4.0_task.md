---
status: completed
parallelizable: true
blocked_by: ["1.0"]
---

<task_context>
<domain>frontend/hooks</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>medium</complexity>
<dependencies>http_server</dependencies>
<unblocks>6.0</unblocks>
</task_context>

# Tarefa 4.0: Implementar hook useBarbeariaCode e validação de código

## Visão Geral

Criar custom hook `useBarbeariaCode` que extrai o código da barbearia da URL usando `useParams()`, valida o código no backend via `GET /api/barbearias/codigo/:codigo`, e gerencia estados de loading, sucesso e erro. Este hook é fundamental para toda a autenticação de Admin Barbearia.

<requirements>
- Hook deve extrair parâmetro `:codigo` da URL
- Validar formato do código localmente (8 caracteres alfanuméricos)
- Fazer request ao endpoint `GET /api/barbearias/codigo/:codigo`
- Gerenciar estados: loading, data, error
- Retornar dados básicos da barbearia (id, nome, código, isActive)
- Tratar erros 404 (código não encontrado) e 403 (barbearia inativa)
- Cache de validação para evitar requests repetidos
</requirements>

## Subtarefas

- [ ] 4.1 Criar arquivo `src/hooks/useBarbeariaCode.ts`
- [ ] 4.2 Implementar interface `UseBarbeariaCodeReturn`
- [ ] 4.3 Implementar extração de código via `useParams()`
- [ ] 4.4 Adicionar validação local de formato (regex)
- [ ] 4.5 Criar serviço `barbeariaService.validateCode(codigo)`
- [ ] 4.6 Implementar lógica de request com React Query
- [ ] 4.7 Adicionar tratamento de erros específicos
- [ ] 4.8 Implementar cache e invalidação
- [ ] 4.9 Criar tipos TypeScript em `src/types/adminBarbearia.ts`
- [ ] 4.10 Criar schema Zod em `src/schemas/adminBarbearia.schema.ts`
- [ ] 4.11 Criar testes unitários em `src/hooks/__tests__/useBarbeariaCode.test.ts`
- [ ] 4.12 Documentar uso do hook com exemplos

## Sequenciamento

- **Bloqueado por:** 1.0 (Endpoint backend deve existir)
- **Desbloqueia:** 6.0 (Página de login)
- **Paralelizável:** Sim (pode executar em paralelo com 5.0 após 1.0)

## Detalhes de Implementação

### Tipos TypeScript

```typescript
// src/types/adminBarbearia.ts
export interface BarbeariaInfo {
  id: string;
  nome: string;
  codigo: string;
  isActive: boolean;
}

export interface UseBarbeariaCodeReturn {
  codigo: string | undefined;
  barbeariaInfo: BarbeariaInfo | null;
  isLoading: boolean;
  error: Error | null;
  isValidating: boolean;
}
```

### Schema Zod

```typescript
// src/schemas/adminBarbearia.schema.ts
import { z } from 'zod';

export const codigoSchema = z
  .string()
  .length(8, 'Código deve ter 8 caracteres')
  .regex(/^[A-Z0-9]{8}$/, 'Código deve conter apenas letras maiúsculas e números');

export const barbeariaInfoSchema = z.object({
  id: z.string().uuid(),
  nome: z.string(),
  codigo: codigoSchema,
  isActive: z.boolean(),
});
```

### Serviço de API

```typescript
// src/services/barbearia.service.ts
import { api } from './api';
import { BarbeariaInfo } from '@/types/adminBarbearia';

export const barbeariaService = {
  validateCode: async (codigo: string): Promise<BarbeariaInfo> => {
    const response = await api.get<BarbeariaInfo>(`/api/barbearias/codigo/${codigo}`);
    return response.data;
  },
};
```

### Hook Implementation

```typescript
// src/hooks/useBarbeariaCode.ts
import { useParams } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import { barbeariaService } from '@/services/barbearia.service';
import { codigoSchema } from '@/schemas/adminBarbearia.schema';
import type { UseBarbeariaCodeReturn } from '@/types/adminBarbearia';

export function useBarbeariaCode(): UseBarbeariaCodeReturn {
  const { codigo } = useParams<{ codigo: string }>();

  // Validação local do formato
  const isValidFormat = codigo ? codigoSchema.safeParse(codigo).success : false;

  const {
    data: barbeariaInfo,
    isLoading,
    error,
    isValidating,
  } = useQuery({
    queryKey: ['barbearia-code', codigo],
    queryFn: () => barbeariaService.validateCode(codigo!),
    enabled: !!codigo && isValidFormat, // Só executa se código existe e tem formato válido
    retry: false, // Não retry em 404/403
    staleTime: 5 * 60 * 1000, // Cache por 5 minutos
    gcTime: 10 * 60 * 1000, // Garbage collection após 10 minutos
  });

  return {
    codigo,
    barbeariaInfo: barbeariaInfo ?? null,
    isLoading,
    error: error as Error | null,
    isValidating,
  };
}
```

### Exemplo de Uso

```typescript
// Em LoginAdminBarbearia.tsx
import { useBarbeariaCode } from '@/hooks/useBarbeariaCode';

export function LoginAdminBarbearia() {
  const { codigo, barbeariaInfo, isLoading, error } = useBarbeariaCode();

  if (isLoading) {
    return <div>Validando código da barbearia...</div>;
  }

  if (error) {
    if (error.message.includes('404')) {
      return <div>Barbearia não encontrada</div>;
    }
    if (error.message.includes('403')) {
      return <div>Barbearia temporariamente indisponível</div>;
    }
    return <div>Erro ao validar código</div>;
  }

  if (!barbeariaInfo) {
    return <div>Código inválido</div>;
  }

  return (
    <div>
      <h1>Login - {barbeariaInfo.nome}</h1>
      {/* Formulário de login */}
    </div>
  );
}
```

## Critérios de Sucesso

- [ ] Hook extrai código da URL corretamente
- [ ] Validação local de formato funciona (8 caracteres alfanuméricos)
- [ ] Request ao backend é feito apenas se formato é válido
- [ ] Estados de loading, data e error funcionam corretamente
- [ ] Erro 404 retorna mensagem "Barbearia não encontrada"
- [ ] Erro 403 retorna mensagem "Barbearia temporariamente indisponível"
- [ ] Cache funciona (requests não são repetidos desnecessariamente)
- [ ] Testes unitários com cobertura >= 80%
- [ ] Documentação clara com exemplos de uso
- [ ] TypeScript types corretos sem any

## Arquivos Afetados

- `src/hooks/useBarbeariaCode.ts` (NOVO)
- `src/types/adminBarbearia.ts` (NOVO)
- `src/schemas/adminBarbearia.schema.ts` (NOVO)
- `src/services/barbearia.service.ts` (NOVO)
- `src/hooks/__tests__/useBarbeariaCode.test.ts` (NOVO)

## Estimativa

- **Esforço:** 1-2 dias
- **Complexidade:** Média
