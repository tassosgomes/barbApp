# barbApp Project State Full Report

The barbApp is a multi-tenant barbershop management application built on .NET 8 using Clean Architecture principles. The system implements a layered architecture with strict dependency rules, where the Domain layer is at the center with zero external dependencies, surrounded by Application, Infrastructure, and API layers.

The technology stack is modern and enterprise-grade, utilizing ASP.NET Core Web API, Entity Framework Core with PostgreSQL database, JWT-based authentication, and comprehensive test coverage including unit tests, application tests, integration tests, and infrastructure tests.

This document provides a comprehensive snapshot of the project's current state, consolidating architectural analysis and dependency audit findings to provide an X-ray view of the codebase. The report identifies 74 critical components across 5 architectural layers, analyzes 27 direct dependencies, and highlights critical security vulnerabilities and architectural risks requiring attention.

Generated on: 2025-10-12-16:23:47

## Overview and Architecture

[Architectural Analysis Report](/docs/agents/architectural-analyzer/architectural-report-2025-10-12-10:50:45.md)

The architectural analysis reveals a well-structured Clean Architecture implementation with clear separation of concerns across Domain, Application, Infrastructure, and API layers. The system demonstrates mature understanding of domain-driven design with proper entity modeling, value objects, repository patterns, and use case orchestration.

Key architectural characteristics include strong layer isolation, comprehensive middleware pipeline, structured exception handling, dependency injection throughout, and a clear authentication/authorization strategy supporting multiple user roles (AdminCentral, AdminBarbearia, Barbeiro, Cliente).

The multi-tenancy pattern is implemented through tenant context extraction from JWT claims and global query filters on DbContext for automatic isolation, ensuring secure data separation between barbershops.

Critical architectural concerns identified include:
- Single points of failure in ITenantContext, BarbAppDbContext, and JWT configuration
- No database redundancy or failover mechanisms
- Potential query filter performance issues at scale
- Missing rate limiting and DoS protection
- Insufficient audit logging for compliance requirements

## Components

The architectural analysis identified 74 architecturally significant components requiring individual analysis:

### Domain Layer Components (20 components)
- Barbershop Entity
- AdminCentralUser Entity
- AdminBarbeariaUser Entity
- Barber Entity
- Customer Entity
- BarbeariaCode Value Object
- ITenantContext Interface
- Repository Interfaces (5): IAdminCentralUserRepository, IAdminBarbeariaUserRepository, IBarberRepository, ICustomerRepository, IBarbershopRepository
- Domain Exceptions (8): DomainException, UnauthorizedException, UnauthorizedAccessException, ForbiddenException, NotFoundException, BarbeariaInactiveException, InvalidBarbeariaCodeException, ValidationException

### Application Layer Components (28 components)
- Service Interfaces (3): IAuthenticationService, IJwtTokenGenerator, IPasswordHasher
- Use Case Interfaces (6): IAuthenticateAdminCentralUseCase, IAuthenticateAdminBarbeariaUseCase, IAuthenticateBarbeiroUseCase, IAuthenticateClienteUseCase, IListBarbeirosBarbeariaUseCase, ITrocarContextoBarbeiroUseCase
- Use Case Implementations (6): AuthenticateAdminCentralUseCase, AuthenticateAdminBarbeariaUseCase, AuthenticateBarbeiroUseCase, AuthenticateClienteUseCase, ListBarbeirosBarbeariaUseCase, TrocarContextoBarbeiroUseCase
- Input Validators (5): LoginAdminCentralInputValidator, LoginAdminBarbeariaInputValidator, LoginBarbeiroInputValidator, LoginClienteInputValidator, TrocarContextoInputValidator
- DTOs (8): AuthenticationOutput, AuthResponse, LoginClienteInput, LoginAdminBarbeariaInput, LoginAdminCentralInput, LoginBarbeiroInput, TrocarContextoInput, BarberInfo

### Infrastructure Layer Components (18 components)
- BarbAppDbContext
- Services (3): TenantContext, JwtTokenGenerator, PasswordHasher
- Middlewares (2): TenantMiddleware, GlobalExceptionHandlerMiddleware
- Repositories (5): AdminCentralUserRepository, AdminBarbeariaUserRepository, BarberRepository, CustomerRepository, BarbershopRepository
- Entity Configurations (5): AdminCentralUserConfiguration, AdminBarbeariaUserConfiguration, BarberConfiguration, CustomerConfiguration, BarbershopConfiguration
- Configuration Classes (2): JwtSettings, MiddlewareExtensions

### API Layer Components (4 components)
- AuthController
- ValidationConfiguration Extension
- SwaggerExamplesSchemaFilter
- Program (Startup Configuration)

### Test Components (4 projects)
- BarbApp.Domain.Tests
- BarbApp.Application.Tests
- BarbApp.Infrastructure.Tests
- BarbApp.IntegrationTests

## Dependencies

[Dependency Audit Report](/docs/agents/dependency-auditor/dependencies-report-2025-10-12-10:54:56.md)

The dependency audit analyzed 27 unique NuGet packages and identified critical security vulnerabilities and outdated dependencies requiring immediate attention.

### Critical Security Issues

**CVE-2024-21319: Denial of Service in JWT Authentication**
- Affected Package: System.IdentityModel.Tokens.Jwt 7.5.1
- Severity: High
- Impact: Authentication system vulnerability allowing unauthenticated clients to consume excessive memory
- Critical Files: JwtTokenGenerator.cs (authentication service)

**CVE-2024-43485: Denial of Service in System.Text.Json**
- Affected Package: System.Text.Json 9.0.1
- Severity: High
- Impact: Algorithmic complexity attacks via JSON deserialization
- Critical Files: GlobalExceptionHandlerMiddleware.cs, all API endpoints

**Deprecated Legacy Package**
- Package: Microsoft.AspNetCore.Http 2.2.2
- Status: End of life since December 2019
- Impact: Infrastructure layer middleware implementations (TenantMiddleware, GlobalExceptionHandlerMiddleware, MiddlewareExtensions)

### Dependency Status Summary

- Total direct dependencies: 27 packages
- Outdated dependencies: 14 packages
- Up-to-date dependencies: 12 packages
- Legacy/deprecated: 1 package
- Known vulnerabilities: 2 critical CVEs
- Overall Risk Level: HIGH

### Critical Files Affected

1. JwtTokenGenerator.cs - Authentication service using vulnerable JWT library
2. PasswordHasher.cs - Credential security (package up-to-date)
3. GlobalExceptionHandlerMiddleware.cs - Uses deprecated HTTP abstractions and vulnerable JSON serialization
4. TenantMiddleware.cs - Multi-tenancy isolation using deprecated HTTP abstractions
5. BarbAppDbContext.cs - Central database context with outdated EF Core
6. Program.cs - Application startup integrating all outdated dependencies
7. All Repository implementations - Affected by outdated EF Core 9.0.0
8. Entity Configurations - Schema management with outdated EF Core
9. MiddlewareExtensions.cs - Middleware registration using deprecated abstractions

### Technology Stack

**Runtime & Framework:**
- .NET 8 (supported until November 10, 2026)
- ASP.NET Core Web API

**Data Access:**
- Entity Framework Core 9.0.0 (outdated, latest: 9.0.9)
- Npgsql.EntityFrameworkCore.PostgreSQL 9.0.0 (outdated, latest: 9.0.4)
- PostgreSQL database

**Authentication & Security:**
- JWT Bearer tokens (Microsoft.AspNetCore.Authentication.JwtBearer 8.0.10 - outdated)
- System.IdentityModel.Tokens.Jwt 7.5.1 (VULNERABLE - CVE-2024-21319)
- BCrypt.Net-Next 4.0.3 (up-to-date)

**Validation & Serialization:**
- FluentValidation 12.0.0 (up-to-date)
- System.Text.Json 9.0.1 (VULNERABLE - CVE-2024-43485)

**Logging & Monitoring:**
- Serilog.AspNetCore 8.0.0 (outdated, latest: 9.0.0)
- Serilog.Sinks.Console 5.0.0 (outdated, latest: 6.0.0)
- Serilog.Sinks.File 5.0.0 (outdated, latest: 7.0.0)

**API Documentation:**
- Swashbuckle.AspNetCore 6.6.2 (severely outdated, latest: 9.0.6)

**Testing:**
- xUnit 2.5.3 (outdated, latest: 2.9.3)
- Microsoft.AspNetCore.Mvc.Testing 8.0.10 (outdated)
- Testcontainers.PostgreSql 3.10.0 (outdated, latest: 4.7.0)
